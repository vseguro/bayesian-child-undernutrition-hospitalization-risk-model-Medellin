---
title: "Desnutrición"
output:
  pdf_document: default
  html_document: default
date: '2022-06-08'
---
En este documento se carga la base de datos actualizada y se elimina todos los valores atípicos según la resolución de Colombia dadas las medidas antropométricas WHZ, WAZ, HAZ.

Además se consolida en una sola base de datos la información de desnutrición de los años 2022 y 2023.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, eval=FALSE)
```

```{r, warning=FALSE, message=FALSE, eval=TRUE}
# Loading libraries:
library(dplyr)
library(knitr)
library(ggplot2)
library(readxl)
library(kableExtra)
source("../utils/load_data.R")
```

```{r}
# Reading data:
data_2021 <- LoadData("sivigila_desnutricion_hasta_2021.csv", data_type = "raw", sep = ";")
data_2022 <- LoadData("sivigila_desnutricion_2022.xlsx", data_type = "raw")
data_2023 <- LoadData("sivigila_desnutricion_2023.xlsx", data_type = "raw")
```

```{r}
colnames(data_2021)
```

```{r}
colnames(data_2022) <- c(colnames(data_2022)[1:7], "tipo_ss_", colnames(data_2022)[9:23],
                         "per_braqu", "evento", colnames(data_2022)[26])
colnames(data_2022)
```

```{r}
colnames(data_2023) <- c(colnames(data_2023)[1:7], "tipo_ss_", colnames(data_2023)[9:23],
                         "per_braqu", colnames(data_2023)[25:26])
```

```{r}
# Variables of interest:
data_2021 <- data_2021[,c(1,3:5,6,7,8,13,16:20,22:24, 26)]
data_2022 <- data_2022[,c(1,3:5,6,7,8,13,16:20,22:24, 26)]
data_2023 <- data_2023[,c(1,3:5,6,7,8,13,16:20,22:24, 26)]
```

```{r}
full_data <- rbind(data_2021, data_2022, data_2023)
```

```{r}
# Conversion to required format:
full_data <- within(full_data,{
  edad_ <- as.numeric(edad_)
  uni_med_ <- as.factor(uni_med_)
  sexo_ <- as.factor(sexo_)
  nombre_barrio <- as.factor(nombre_barrio)
  comuna <- as.factor(comuna)
  pac_hos_ <- as.factor(pac_hos_)
  edad_ges <- as.numeric(edad_ges)
  t_lechem <- as.numeric(t_lechem)
  e_complem <- as.numeric(e_complem)
  crec_dllo <- as.factor(crec_dllo)
  esq_vac <- as.factor(esq_vac)
  tipo_ss_ <- as.factor(tipo_ss_)
  year_ <- as.factor(year_)
})

full_data$peso_act <- sub(",",".", full_data$peso_act) |> as.numeric()
full_data$talla_act <- sub(",",".", full_data$talla_act) |> as.numeric()
full_data$per_braqu <- sub(",",".", full_data$per_braqu) |> as.numeric()
summary(full_data)
```

```{r}
table(full_data$year_)
```

```{r}
# Age conversion: Function:
age_conversion <- function(year, unidad){
  if(unidad == "1"){ # Year
    age <- year*12
  }
  else if(unidad == "3"){ # Days
    age <- year/30
  }else if(unidad == "4"){
    age <- year/720
  }else {
    age <- year
  }
  return(age)
}


# This function is applied to convert age to months:
for(i in 1:dim(full_data)[1]){
 full_data$edad_[i] <- age_conversion(full_data[i,2],full_data[i,3])
}

# Eliminate variable unit of measurement: 
full_data <- full_data[,-3] 

# Unify levels of some of the variables: 
levels(full_data$comuna) <- sub("^\\d*\\s*", "", levels(full_data$comuna)) 

levels(full_data$comuna)[levels(full_data$comuna) %in% c("SIN INFORMACION", "Sin información", "Sin Información")] <- "Sin informacion" 
levels(full_data$comuna)[levels(full_data$comuna)=="Corregimiento de Altavista"] <- "Altavista" 
levels(full_data$comuna)[levels(full_data$comuna)=="Corregimiento de Palmitas"] <- "San Sebastian de Palmitas"
levels(full_data$comuna)[levels(full_data$comuna)=="Corregimiento de Santa Elena"] <- "Corregimiento De Santa Elena" 
levels(full_data$comuna)[levels(full_data$comuna)=="Corregimiento de San Antonio de Prado"] <- "San Antonio de Prado" 
levels(full_data$comuna)[levels(full_data$comuna)=="Doce De Octubre"] <- "Doce de Octubre" 
levels(full_data$comuna)[levels(full_data$comuna)=="Corregimiento de San Cristóbal"] <- "Corregimiento de San Cristobal"
levels(full_data$comuna)[levels(full_data$comuna)=="Laureles Estadio"] <- "Laureles" 
levels(full_data$comuna)[levels(full_data$comuna)=="La América"] <- "La America" 
levels(full_data$comuna)[levels(full_data$comuna)=="Belén"] <- "Belen" 
```


```{r} 
sort(levels(full_data$comuna)) 
``` 

```{r} 
summary(full_data) # En kg 
```

```{r}
full_data[(is.na(full_data$edad_ges)) | (full_data$edad_ges == 0), ]
test <- full_data[full_data$edad_ges != 0, ]
summary(test)
```

```{r}
# Remove rows with edad_ges = 0
full_data_sinNa <- full_data[!is.na(full_data$edad_ges), ]
full_data <- full_data_sinNa[full_data_sinNa$edad_ges != 0, ]
summary(full_data)
```

```{r}
# Convert variable "hospitalized patients" to yes and no levels:
full_data <- full_data %>%
  mutate(
  esq_vac = case_when(
    esq_vac == "1" ~ "Yes",
    esq_vac == "2" ~ "No",
    esq_vac == "3" ~ "Unknown",
  ),
  tipo_ss_ = case_when(
    tipo_ss_ == "C" ~ "Contributive",
    tipo_ss_ == "E" ~ "Special",
    tipo_ss_ == "I" ~ "Pending",
    tipo_ss_ == "N" ~ "Uninsured",
    tipo_ss_ == "P" ~ "Special", #<- excepcion
    tipo_ss_ == "S" ~ "Subsidized"
  )
) 
``` 

```{r} 
full_data$tipo_ss_ <- as.factor(full_data$tipo_ss_) 
full_data$esq_vac <- as.factor(full_data$esq_vac)
```

```{r} 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Alejandro Echavarria" ] <- "Alejandro Echavarría" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Alfonso Lopez"] <- "Alfonso López" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Andalucia" ] <- "Andalucía" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Area De Expansion Altavista" ] <- "Área De Expansión Altavista" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Area de Expansion El Noral"   ] <- "Área de Expansión El Noral"   
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Area de Expansion Altos de Calasanz"    ] <-  "Área de Expansión Altos de Calasanz"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Area de Expansion Pajarito"   ] <- "Área de Expansión Pajarito" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Asomadera No. 1"] <- "Asomadera No.1" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Asomadera N.1"] <- "Asomadera No.1" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Aures N.1"   ] <-  "Aures No.1" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Aures No. 2"   ] <-  "Aures No.2" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Aures N.2"   ] <-  "Aures No.2" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Barrio Caycedo"  ] <-  "Barrio Caicedo" 
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Barrio Colon"  ] <-   "Barrio Colón"   
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Barrios de Jesus"  ] <-  "Barrio de Jesús"    
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Barro Blanco"  ] <-"Barrio Blanco"   
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Belalcazar"] <-"Belalcázar"  
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Belen" ] <- "Belén" 
#  levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Bermejal Los Alamos" ] <- "Bermejal-Los Álamos"
#  levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Bomboná N.1" ] <- "Bombona No.1"
#  levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Bomboná No. 1" ] <- "Bombona No.1"
#  levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)=="Bomboná No. 2"  ] <- "Bombona No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Boyaca"  ] <- "Boyacá"
#  levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Cabecera aurbana San Cristobal"  ] <- "Cabecera Urbana San Cristobal"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Campo Valdés No. 1"  ] <- "Campo Valdes No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Campo Valdés N.1"  ] <- "Campo Valdes No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Campo Valdés No. 2"  ] <- "Campo Valdes No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Campo Valdés N.2"  ] <- "Campo Valdes No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Corazon de Jesus"  ] <- "Corazón de Jesús"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Cordoba" ] <- "Córdoba"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Doce de Octubre N.1" ] <- "Doce de Octubre No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Doce de Octubre N.2" ] <- "Doce de Octubre No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Doce de Octubre N.2" ] <- "Doce de Octubre No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "El Nogallos Almendros"  ] <- "El Nogal-Los Almendros"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "El Rincon"] <- "El Rincón"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "Fatima"] <- "Fátima"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "La America" ] <- "La América"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)== "La Hondanada"  ] <- "La Hondonada"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "La Mansion"   ] <- "La Mansión"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "La piñuela"   ] <- "La Piñuela"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "LLanaditas"    ] <- "Llanaditas"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Lopez de Mesa"] <- "López de Mesa"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Los Alcazares" ] <- "Los Alcázares"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Manrique Central N.1" ] <- "Manrique Central No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Manrique Central No. 1" ] <- "Manrique Central No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Manrique Central N.2" ] <- "Manrique Central No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Manrique Central No. 2" ] <- "Manrique Central No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Maria Cano-Carambolas" ] <- "María Cano Carambolas"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Maria Cano Carambolas" ] <- "María Cano Carambolas"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Moscú No. 1" ] <- "Moscú No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Moscú N.1" ] <- "Moscú No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Moscú No. 2" ] <- "Moscú No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Moscú N.2" ] <- "Moscú No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Nueva Villa de La Iguana" ] <- "Nueva Villa de la Iguaná"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Nueva Villa de La Iguaná" ] <- "Nueva Villa de la Iguaná"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Playon de Los Comuneros" ] <-  "Playón de Los Comuneros"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Progreso N.2" ] <-  "Progreso No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "San German" ] <-  "San Germán"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "San Javier N.1"  ] <-  "San Javier No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "San Martin de Porres"  ] <-  "San Martín de Porres"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Santa Ines"  ] <-  "Santa Inés"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Santo Domingo Savio No. 1"  ] <-  "Santo Domingo Savio No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Santo Domingo Savio N.1"   ] <-  "Santo Domingo Savio No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Santo Domingo Savio No. 2"    ] <-  "Santo Domingo Savio No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Santo Domingo Savio N.2"    ] <-  "Santo Domingo Savio No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Simon Bolivar" ] <-  "Simón Bolivar"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Sin informacion" ] <-  "Sin información"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "SIN INFORMACION"   ] <-  "Sin información"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Versalles No. 2" ] <-  "Versalles No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Versalles N.2" ] <-  "Versalles No.2"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Versalles No. 1" ] <-  "Versalles No.1"
# levels(data.active$nombre_barrio)[levels(data.active$nombre_barrio)==  "Villa Liliam"  ] <-  "Villa Lilliam"
```

```{r}
full_data$country <- "Colombia" 
```

```{r}
# Export database:
SaveData(full_data, data_folder = "interim", file_name = "full_data.csv")
```

# Zscores

Con la base de datos guardada, se procede a calcular WHZ, HAZ, WAZ con el aplicativo de la OMS para eliminar valores atípicos y proceder al análisis descriptivo

```{r}
# Read
full_data_zscore <- LoadData("full_data_zscore.csv", data_type = "raw", sep = ",")

full_data_zscore <- full_data_zscore[, -1]

full_data_zscore <- full_data_zscore[,-c(1:2,18:26,28,30:32, 34)]

# Change column names:

full_data_zscore <- rename(full_data_zscore, HAZ = zlen, WAZ = zwei, WHZ = zwfl)
```

# Analysis of outliers
```{r}
summary(full_data_zscore$HAZ) #Talla para edad = retraso crecimiento
summary(full_data_zscore$WHZ) #Peso para talla = desnutrición aguda
summary(full_data_zscore$WAZ) #Peso para la edad = bajo peso

# Check the database for any null values:
na <- full_data_zscore %>% filter(is.na(peso_act))
full_data_zscore_Na <- full_data_zscore %>% filter(is.na(WHZ)) # data with NA in variable WHZ
colnames(full_data_zscore)[apply(full_data_zscore, 2, function(x) anyNA(x))]

# Remove rows with NA in variable WHZ:
full_data_zscore <- full_data_zscore %>% filter(!is.na(WHZ))

# Missing observations:
full_data_zscore_Na$median <- c(5.9907,6.3738,3.1560,2.4410,5.5632,6.3738,2.948)
full_data_zscore_Na$variation <- c(0.08342,0.09135,0.0906,0.09182,0.08406,0.09135,0.09007)

full_data_zscore_Na$WHZ <- mapply(WHZIndexCalculation, split(full_data_zscore_Na, seq(nrow(full_data_zscore_Na))))

full_data_zscore_Na <- full_data_zscore_Na[,-c(19,20)]

full_data_zscore <- rbind(full_data_zscore,full_data_zscore_Na)

# Number of outliers: 101
sum(
  (full_data_zscore$WHZ < -5 | full_data_zscore$WHZ > 5) |
    (full_data_zscore$HAZ < -6 | full_data_zscore$HAZ > 6) |
    (full_data_zscore$WAZ < -5 | full_data_zscore$WAZ > 5)
)

# Total observations after removing outliers: 4320
full_data_zscore_with_Index <- subset(full_data_zscore,
                                 !(full_data_zscore$WHZ < -5 | full_data_zscore$WHZ > 5 | full_data_zscore$HAZ < -6 | full_data_zscore$HAZ > 6 | full_data_zscore$WAZ < -5 | full_data_zscore$WAZ > 5)
)

nrow(full_data_zscore_with_Index)
prop.table(table(full_data_zscore_with_Index$pac_hos_))
table(full_data_zscore_with_Index$year_,full_data_zscore_with_Index$pac_hos_)
prop.table(table(full_data_zscore_with_Index$year_,full_data_zscore_with_Index$pac_hos_),margin = 1)
```

```{r}
# Create levels for variable type of malnutrition

full_data_zscore_with_Index <- full_data_zscore_with_Index %>%
  mutate(
    Type_malnutrition = case_when(
      WHZ > -2 ~ 1, # Normal
      WHZ >= -3 & WHZ <= -2 ~ 2, # Moderado
      WHZ < -3 ~ 3, # Severa
    )
  )
```

```{r}
# Create levels for variable CIAF:
full_data_zscore_with_Index <- full_data_zscore_with_Index %>%
  mutate(
    CIAF = case_when(
      WAZ > -2 & HAZ > -2 & WHZ > -2 ~ "A",
      WHZ <= -2 & WAZ > -2 & HAZ > -2 ~ "B",
      WHZ <= -2 & WAZ <= -2 & HAZ > -2 ~ "C",
      WHZ <= -2 & WAZ <= -2 & HAZ <= -2 ~ "D",
      WHZ > -2 & WAZ <= -2 & HAZ <= -2 ~ "E",
      WHZ > -2 & WAZ > -2 & HAZ <= -2 ~ "F_",
      WHZ > -2 & WAZ <= -2 & HAZ > -2 ~ "Y",
    )
  )
```

```{r}
# export database without atypicals and with indexes:
SaveData(full_data_zscore_with_Index, data_folder = "interim", file_name = "full_data_Index_without_Outliers.csv")
```

# Descriptive analysis

```{r, eval=TRUE}
# read:
datos_final <- LoadData("full_data_Index_without_Outliers.csv",data_type = "interim", sep = ",")
```

```{r}
# Average weight by age:

prom_edad = datos_final%>% group_by(as.factor(edad_))  %>%
  summarise(pesoprom = mean(peso_act),
            .groups = 'drop')
prom_edad
```


```{r, eval=TRUE, fig.height= 7, fig.width= 10}
# Scatter plot weight vs height:

p <- ggplot(datos_final, aes(peso_act, talla_act)) +
  geom_point(aes(colour = factor(pac_hos_)))+
  guides(colour = guide_legend(title = "Hospitalization")) +
  ggtitle("Scatter plot weight vs height")+
  xlab("Weight")+
  ylab("Height")+
  scale_color_manual(values = c("#F52525","#5b8cad"), labels = c("Yes", "No"))
p
```

```{r, eval=TRUE}
data_tablas <- datos_final %>%
  mutate(
  pac_hos_ = case_when(
    pac_hos_ == "1" ~ "Sí_h",
    pac_hos_ == "2" ~ "No_h"
  ),
  crec_dllo = case_when(
    crec_dllo == "1" ~ "Sí",
    crec_dllo == "2" ~ "No"
  )
)
```

```{r}
# Proportion of hospitalized children based on attendance to growth and development:

cont_crec_dllo <- prop.table(table(data_tablas$pac_hos_, data_tablas$crec_dllo), margin = 2)

kable(cont_crec_dllo, digits = 4, caption="Proportion of hospitalized children according to attendance at a growth and development program", format = "latex",booktabs=TRUE, col.names = c("No","Yes"))%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)%>%add_header_above(c("Hospitalization" = 1,"growth and development program" = 2))
```

\newpage

```{r, fig.height= 7, fig.width= 10, eval=TRUE}
# Bar chart of the proportion of children attending growth and development vs hospitalization
cont_crec_dllo <- prop.table(table(data_tablas$pac_hos_, data_tablas$crec_dllo), margin = 2)
cont_crec_dllo <- round(cont_crec_dllo, 3)
crec_Hospi <- barplot(cont_crec_dllo,
                      beside = TRUE,
                      xlab='growth and development program',
                      ylab='Proportion',
                      col=c("#5b8cad","#F52525"),
                      space = c(0.05, 0.2),
                      ylim = c(0.0,1),
                      main = "Proportion of hospitalized children according to \n attendance at a growth and development program")
legend('topright', legend= c("No", "Yes"), bty='n',
       fill=c("#5b8cad","#F52525"), title = "Hospitalized patient")

text(crec_Hospi, cont_crec_dllo + 0.05, labels = cont_crec_dllo)
```

```{r}
# Contingency table of tipo_ss_ vs. pac_hos marginalized by type of social security:

tipo_ss_numpac <- table(data_tablas$pac_hos_,data_tablas$tipo_ss_)
prop_tipo_ss_numpac <- prop.table(tipo_ss_numpac, margin = 2)

kable(prop_tipo_ss_numpac, digits = 4, caption="Proporción de niños hospitalizados según el tipo de seguridad social", format = "latex",booktabs=TRUE, col.names = c("Contributivo", "Especial","Pendiente", "No asegurado","Subsidiado"))%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)%>%add_header_above(c("Hospitalizado" = 1,"Tipo de seguridad social" = 5))
```

\newpage

```{r,fig.height= 7, fig.width= 10, eval=TRUE}
# Social Security Graph:

cont_ss <- prop.table(table(data_tablas$pac_hos_, data_tablas$tipo_ss_), margin = 2)
cont_ss <- round(cont_ss, 3)
p4 <- barplot(cont_ss,
                      beside = TRUE,
                      xlab='Type of social security',
                      ylab='Proportion',
                      col=c("#5b8cad","#F52525"),
                      space = c(0.05, 0.2),
                      ylim = c(0.0,1),
                      main = "Proportion of hospitalized children according to type of social security")
legend('topright', legend= c("No", "Yes"), bty='n',
       fill=c("#5b8cad","#F52525"), title = "Hospitalized patient")
text(p4, cont_ss + 0.025, labels = cont_ss)
```

\newpage

```{r}
# Contingency table of esq_vac vs. pac_hos marginalized by vaccination scheme

esq_vac_pachos <- table(data_tablas$pac_hos_,data_tablas$esq_vac)
prop_esq_vac_pachos <- prop.table(esq_vac_pachos, margin = 2)
kable(prop_esq_vac_pachos, digits = 4, caption="Proporción de niños hospitalizados y esquema de vacunación", format = "latex",booktabs=TRUE, col.names = c("Desconocido","No","Sí"))%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)%>%add_header_above(c("Hospitalizado" = 1,"Esquema de vacunación" = 3))
```

```{r,fig.height= 7, fig.width= 10, eval=TRUE}
# Vaccination Scheme Graph

cont_v <- prop.table(table(data_tablas$pac_hos_, data_tablas$esq_vac), margin = 2)
cont_v <- round(cont_v, 3)
p5 <- barplot(cont_v,
                      beside = TRUE,
                      xlab='Vaccination schedule',
                      ylab='Proportion',
                      col=c("#5b8cad","#F52525"),
                      space = c(0.05, 0.2),
                      ylim = c(0.0,1),
                      main = "Proportion of hospitalized children according to Vaccination schedule")
legend('topright', legend= c("No", "Yes"), bty='n',
       fill=c("#5b8cad","#F52525"), title = "Hospitalized patient")
text(p5, cont_v + 0.025, labels = cont_v)
```

\newpage

```{r}
# Table with proportion of hospitalized children by gender:

pac_hosp_sexo <- table(data_tablas$pac_hos_,data_tablas$sexo_)
prop_pac_hosp_sexo <- prop.table(pac_hosp_sexo, margin = 2)

kable(prop_pac_hosp_sexo, digits = 4, caption="Proporción de niños hospitalizados por género", format = "latex",booktabs=TRUE)%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)%>%add_header_above(c("Hospitalizado" = 1,"Género" = 2))
```

```{r,fig.height= 7, fig.width= 10, eval=TRUE}
# Gender graph:

cont_genero <- prop.table(table(data_tablas$pac_hos_, data_tablas$sexo_), margin = 2)
cont_genero <- round(cont_genero, 3)
p3 <- barplot(cont_genero,
                      beside = TRUE,
                      xlab='Gender',
                      ylab='Proportion',
                      col=c("#5b8cad","#F52525"),
                      space = c(0.05, 0.2),
                      ylim = c(0.0,1),
                      main = "Proportion of hospitalized children according to gender")
legend('topright', legend= c("No", "Yes"), bty='n',
       fill=c("#5b8cad","#F52525"), title = "Hospitalized patient")
text(p3, cont_genero + 0.05, labels = cont_genero)
```

\newpage

```{r, eval=TRUE}
# Table of Hospitalizations by commune

total_hos_comuna <- table(data_tablas$comuna,data_tablas$pac_hos_)
hosp_comuna <- round(prop.table(table(data_tablas$comuna,data_tablas$pac_hos_), margin = 1),4)
uno <- data.frame(hosp_comuna[,1])
dos <- data.frame(hosp_comuna[,2])
totalcomuna <- as.data.frame(table(data_tablas$comuna))
hospxcomuna <- cbind(totalcomuna,uno,dos)
colnames(hospxcomuna) <- c("commune", "Frequency", "Hospitalized", "Not hospitalized")

kable(hospxcomuna[,2:4], digits = 4, caption="Proportion of hospitalized children by commune", format = "latex",booktabs=TRUE)%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)
```

\newpage

```{r, eval=TRUE}
#Number of children according to CIAF

data_tablas <- datos_final %>%
  mutate(
    CIAF = case_when(
      CIAF == "A" ~ "No anthropometric failure", 
      CIAF == "B" ~ "Wasting only", 
      CIAF == "C" ~ "Wasting and underweight",
      CIAF == "D" ~ "Wasting, underweight and stunting", 
      CIAF == "E" ~ "Stunting and underweight", 
      CIAF == "F_" ~ "Stunting only", 
      CIAF == "Y" ~ "Underweight only",
    )
  )

data_tablas <- datos_final %>%
  mutate(
    pac_hos_ = case_when(
      pac_hos_ == "1" ~ "Yes",
      pac_hos_ == "2" ~ "No"
))

data_tablas <- datos_final %>%
  mutate(
    Type_malnutrition = case_when(
      Type_malnutrition == 1 ~ "No wasting", # Normal
      Type_malnutrition == 2 ~ "Moderate", # Moderado
      Type_malnutrition == 3 ~ "Severe", # Severa
    )
  )

kable(table(data_tablas$CIAF), digits = 4, caption="CIAF", format = "latex",col.names = NA, booktabs=TRUE,)%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)
```

```{r, eval=TRUE}
# Contingency table of CIAF vs. Hospitalization:
Contingency_CIAF_Hosp <- addmargins(table(data_tablas$CIAF,data_tablas$pac_hos_))
kable(Contingency_CIAF_Hosp, digits = 4, caption="CIAF vs. Hospitalization", format = "latex",col.names = NA, booktabs=TRUE,)%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)
```

```{r, eval=TRUE}
# Contingency table of CIAF vs. type malnutrition:
Contingency_CIAF_type <- addmargins(table(data_tablas$CIAF,data_tablas$Type_malnutrition))
kable(Contingency_CIAF_type, digits = 4, caption="CIAF vs. type of acute malnutrition", format = "latex",col.names = NA, booktabs=TRUE,)%>%kable_styling(latex_options = c("HOLD_position"),position = "center",full_width = FALSE)
```

\newpage

# Factor encoding

```{r}
datos_final <- datos_final %>%
  mutate(
    pac_hos_ = case_when(
      pac_hos_ == "1" ~ 1,
      pac_hos_ == "2" ~ 0
))
```

```{r}
datos_final <- datos_final %>%
  mutate(
    esq_vac = case_when(
      esq_vac == "Unknown" ~ 1,
      esq_vac== "No" ~ 2, 
      esq_vac== "Yes" ~ 3,
    ))

datos_final <- datos_final %>%
  mutate(
    tipo_ss_ = case_when(
      tipo_ss_ == "Contributive" ~ 1,
      tipo_ss_== "Special" ~ 2,
      tipo_ss_ == "Uninsured" ~ 3, 
      tipo_ss_ == "Pending" ~ 4, 
      tipo_ss_ == "Subsidized" ~ 5,
    ))
```

```{r}
datos_final <- datos_final %>%
  mutate(
    comuna = case_when(
      comuna == "Altavista" ~ 1,
      comuna == "Aranjuez" ~ 2,
      comuna == "Belen" ~ 3,
      comuna == "Buenos Aires" ~ 4,
      comuna == "Castilla" ~ 5,
      comuna == "Corregimiento de San Cristobal" ~ 6,
      comuna == "Corregimiento De Santa Elena" ~ 7,
      comuna == "Doce de Octubre" ~ 8,
      comuna == "El Poblado" ~ 9,
      comuna == "Guayabal" ~ 10,
      comuna == "La America" ~ 11,
      comuna == "La Candelaria" ~ 12,
      comuna == "Laureles" ~ 13,
      comuna == "Manrique"  ~ 14,
      comuna == "Popular" ~ 15,
      comuna == "Robledo" ~ 16,
      comuna == "San Antonio de Prado" ~ 17,
      comuna == "San Javier" ~ 18,
      comuna == "San Sebastian de Palmitas"  ~ 19,
      comuna == "Santa Cruz"   ~ 20,
      comuna == "Villa Hermosa"   ~ 21,
      comuna == "Sin informacion"   ~ 22
    ))
```

```{r}
datos_final <- datos_final %>%
  mutate(
    sexo_ = case_when(
      sexo_ == "F" ~ 1,
      sexo_== "M" ~ 2
    ))

datos_final <- datos_final %>%
  mutate(
    CIAF = case_when(
      CIAF == "A" ~ 1, 
      CIAF == "B" ~ 2, 
      CIAF == "C" ~ 3,
      CIAF == "D" ~ 4, 
      CIAF == "E" ~ 5, 
      CIAF == "F_" ~ 6, 
      CIAF == "Y" ~ 7,
    )
  )
```

```{r}
datos_final <- datos_final %>%
  mutate(
    year_ = case_when(
      year_ == "2016" ~ 1, 
      year_ == "2017" ~ 2, 
      year_ == "2018" ~ 3,
      year_ == "2019" ~ 4, 
      year_ == "2020" ~ 5, 
      year_ == "2021" ~ 6, 
      year_ == "2022" ~ 7,
      year_ == "2023" ~ 8,
    )
  )
```


```{r}
datos_final <- datos_final[, -c(1,4)]
SaveData(datos_final, data_folder = "processed", file_name = "acute_malnutrition_final_data.csv" )
```

